# Домашнее задание к занятию 2 «Работа с Playbook»

# 9. Подготовьте README.md-файл по своему playbook. В нём должно быть описано: что делает playbook, какие у него есть параметры и теги.

Данный учебный плейбук состоит из двух play.

Первый скачивает и устанавливает пакет vector и копирует в файл конфигурации результат, полученный из шаблона templates/vector.yml, после чего перезапускает сервис с новой конфигурацией.

Второй скачивает и устанавливает пакеты сервера и клиента clickhouse, запускает сервис и создаёт базу данных logs.

В файле vars.yml через переменные заданы список необходимых пакетов и их версии, а также для примера один из параметров конфигурационного файла vector. 


Далее приведены фрагменты вывода при запуске заданий 5-8, а также комментарии.


# 5. Запустите ansible-lint site.yml и исправьте ошибки, если они есть.

Изначально неточностей была куча, но я их вычистил:

```
lebedev@nworkstation:~/homeworks/a02/ans-hw-02/playbook$ ansible-lint site.yml

Passed with production profile: 0 failure(s), 0 warning(s) on 1 files.
```

# 6. Попробуйте запустить playbook на этом окружении с флагом --check

Выдаёт следующую ошибку:

```
TASK [Get clickhouse distrib noarch] ****************************************************************************************************************************************************************
ok: [clickhouse-01] => (item=clickhouse-client)
ok: [clickhouse-01] => (item=clickhouse-server)
failed: [clickhouse-01] (item=clickhouse-common-static) => {"ansible_loop_var": "item", "changed": false, "dest": "./clickhouse-common-static-22.3.3.44.rpm", "elapsed": 0, "gid": 1000, "group": "lebedev", "item": "clickhouse-common-static", "mode": "0664", "msg": "Request failed", "owner": "lebedev", "response": "HTTP Error 404: Not Found", "secontext": "unconfined_u:object_r:user_home_t:s0", "size": 246310036, "state": "file", "status_code": 404, "uid": 1000, "url": "https://packages.clickhouse.com/rpm/stable/clickhouse-common-static-22.3.3.44.noarch.rpm"}
```
Поскольку данная ошибка обходится внутри самого плейбука через resque - я не стал её исправлять.

# 7. Запустите playbook на prod.yml окружении с флагом --diff. Убедитесь, что изменения на системе произведены.

Чтобы clickhouse мог начать работать корректно, пришлось вставить пятисекундную паузу между запуском службы и первой командой. Файл конфигурации для vector я поменял совсем чуть-чуть, чтобы служба не перестала запускаться.

```
lebedev@nworkstation:~/homeworks/a02/ans-hw-02/playbook$ ansible-playbook -i inventory/prod.yml site.yml --diff

PLAY [Install Vector] *******************************************************************************************************************************************************************************

TASK [Gathering Facts] ******************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [Get vector distrib] ***************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [Install vector] *******************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [Ensure vector config in place] ****************************************************************************************************************************************************************
ok: [clickhouse-01]

PLAY [Install Clickhouse] ***************************************************************************************************************************************************************************

TASK [Gathering Facts] ******************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [Get clickhouse distrib noarch] ****************************************************************************************************************************************************************
ok: [clickhouse-01] => (item=clickhouse-client)
ok: [clickhouse-01] => (item=clickhouse-server)
failed: [clickhouse-01] (item=clickhouse-common-static) => {"ansible_loop_var": "item", "changed": false, "dest": "./clickhouse-common-static-22.3.3.44.rpm", "elapsed": 0, "gid": 1000, "group": "lebedev", "item": "clickhouse-common-static", "mode": "0664", "msg": "Request failed", "owner": "lebedev", "response": "HTTP Error 404: Not Found", "secontext": "unconfined_u:object_r:user_home_t:s0", "size": 246310036, "state": "file", "status_code": 404, "uid": 1000, "url": "https://packages.clickhouse.com/rpm/stable/clickhouse-common-static-22.3.3.44.noarch.rpm"}

TASK [Get clickhouse distrib x86_64] ****************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [Install clickhouse packages] ******************************************************************************************************************************************************************
changed: [clickhouse-01]

TASK [Flush handlers] *******************************************************************************************************************************************************************************

RUNNING HANDLER [Start clickhouse service] **********************************************************************************************************************************************************
changed: [clickhouse-01]

RUNNING HANDLER [Pause after restartig clickhouse] **************************************************************************************************************************************************
Pausing for 5 seconds
(ctrl+C then 'C' = continue early, ctrl+C then 'A' = abort)
ok: [clickhouse-01]

TASK [Create database] ******************************************************************************************************************************************************************************
ok: [clickhouse-01]

PLAY RECAP ******************************************************************************************************************************************************************************************
clickhouse-01              : ok=10   changed=2    unreachable=0    failed=0    skipped=0    rescued=1    ignored=0

lebedev@nworkstation:~/homeworks/a02/ans-hw-02/playbook$ ansible-playbook -i inventory/prod.yml site.yml --diff

PLAY [Install Vector] *******************************************************************************************************************************************************************************

TASK [Gathering Facts] ******************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [Get vector distrib] ***************************************************************************************************************************************************************************
changed: [clickhouse-01]

TASK [Install vector] *******************************************************************************************************************************************************************************
changed: [clickhouse-01]

TASK [Ensure vector config in place] ****************************************************************************************************************************************************************
--- before: /etc/vector/vector.yaml
+++ after: /home/lebedev/.ansible/tmp/ansible-local-5524e3o7wh6c/tmpj6_we5tx/vector.yaml
@@ -1,20 +1,3 @@
-#                                    __   __  __
-#                                    \ \ / / / /
-#                                     \ V / / /
-#                                      \_/  \/
-#
-#                                    V E C T O R
-#                                   Configuration
-#
-# ------------------------------------------------------------------------------
-# Website: https://vector.dev
-# Docs: https://vector.dev/docs
-# Chat: https://chat.vector.dev
-# ------------------------------------------------------------------------------
-
-# Change this to use a non-default directory for Vector data storage:
-# data_dir: "/var/lib/vector"
-
 # Random Syslog-formatted logs
 sources:
   dummy_logs:
@@ -23,7 +6,6 @@
     interval: 1

 # Parse Syslog logs
-# See the Vector Remap Language reference for more info: https://vrl.dev
 transforms:
   parse_logs:
     type: "remap"
@@ -39,9 +21,3 @@
     encoding:
       codec: "json"

-# Vector's GraphQL API (disabled by default)
-# Uncomment to try it out with the `vector top` command or
-# in your browser at http://localhost:8686
-# api:
-#   enabled: true
-#   address: "127.0.0.1:8686"

changed: [clickhouse-01]

RUNNING HANDLER [Start vector service] **************************************************************************************************************************************************************
changed: [clickhouse-01]

PLAY [Install Clickhouse] ***************************************************************************************************************************************************************************

TASK [Gathering Facts] ******************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [Get clickhouse distrib noarch] ****************************************************************************************************************************************************************
changed: [clickhouse-01] => (item=clickhouse-client)
changed: [clickhouse-01] => (item=clickhouse-server)
failed: [clickhouse-01] (item=clickhouse-common-static) => {"ansible_loop_var": "item", "changed": false, "dest": "./clickhouse-common-static-22.3.3.44.rpm", "elapsed": 0, "item": "clickhouse-common-static", "msg": "Request failed", "response": "HTTP Error 404: Not Found", "status_code": 404, "url": "https://packages.clickhouse.com/rpm/stable/clickhouse-common-static-22.3.3.44.noarch.rpm"}

TASK [Get clickhouse distrib x86_64] ****************************************************************************************************************************************************************
changed: [clickhouse-01]

TASK [Install clickhouse packages] ******************************************************************************************************************************************************************
changed: [clickhouse-01]

TASK [Flush handlers] *******************************************************************************************************************************************************************************

RUNNING HANDLER [Start clickhouse service] **********************************************************************************************************************************************************
changed: [clickhouse-01]

RUNNING HANDLER [Pause after restartig clickhouse] **************************************************************************************************************************************************
Pausing for 5 seconds
(ctrl+C then 'C' = continue early, ctrl+C then 'A' = abort)
ok: [clickhouse-01]

TASK [Create database] ******************************************************************************************************************************************************************************
ok: [clickhouse-01]

PLAY RECAP ******************************************************************************************************************************************************************************************
clickhouse-01              : ok=11   changed=7    unreachable=0    failed=0    skipped=0    rescued=1    ignored=0
```

# 8. Повторно запустите playbook с флагом --diff и убедитесь, что playbook идемпотентен.  

```
lebedev@nworkstation:~/homeworks/a02/ans-hw-02/playbook$ ansible-playbook -i inventory/prod.yml site.yml --diff

PLAY [Install Vector] *******************************************************************************************************************************************************************************

TASK [Gathering Facts] ******************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [Get vector distrib] ***************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [Install vector] *******************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [Ensure vector config in place] ****************************************************************************************************************************************************************
ok: [clickhouse-01]

PLAY [Install Clickhouse] ***************************************************************************************************************************************************************************

TASK [Gathering Facts] ******************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [Get clickhouse distrib noarch] ****************************************************************************************************************************************************************
ok: [clickhouse-01] => (item=clickhouse-client)
ok: [clickhouse-01] => (item=clickhouse-server)
failed: [clickhouse-01] (item=clickhouse-common-static) => {"ansible_loop_var": "item", "changed": false, "dest": "./clickhouse-common-static-22.3.3.44.rpm", "elapsed": 0, "gid": 1000, "group": "lebedev", "item": "clickhouse-common-static", "mode": "0664", "msg": "Request failed", "owner": "lebedev", "response": "HTTP Error 404: Not Found", "secontext": "unconfined_u:object_r:user_home_t:s0", "size": 246310036, "state": "file", "status_code": 404, "uid": 1000, "url": "https://packages.clickhouse.com/rpm/stable/clickhouse-common-static-22.3.3.44.noarch.rpm"}

TASK [Get clickhouse distrib x86_64] ****************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [Install clickhouse packages] ******************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [Flush handlers] *******************************************************************************************************************************************************************************

TASK [Create database] ******************************************************************************************************************************************************************************
ok: [clickhouse-01]

PLAY RECAP ******************************************************************************************************************************************************************************************
clickhouse-01              : ok=8    changed=0    unreachable=0    failed=0    skipped=0    rescued=1    ignored=0
```